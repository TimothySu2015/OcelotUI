@using OcelotUI.Domain.Entities
@inject IStringLocalizer<SharedResource> L

<MudStack Spacing="3" Class="pa-2">
    <MudGrid>
        <MudItem xs="6">
            <MudTextField T="string"
                          Label="@L["MetadataOpt_CurrentCulture"]"
                          Value="@(Value?.CurrentCulture)"
                          ValueChanged="v => Update(o => o.CurrentCulture = string.IsNullOrWhiteSpace(v) ? null : v)"
                          Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="6">
            <MudTextField T="string"
                          Label="@L["MetadataOpt_NumberStyle"]"
                          Value="@(Value?.NumberStyle)"
                          ValueChanged="v => Update(o => o.NumberStyle = string.IsNullOrWhiteSpace(v) ? null : v)"
                          Variant="Variant.Outlined" />
        </MudItem>
    </MudGrid>

    <MudTextField T="string"
                  Label="@L["MetadataOpt_StringSplitOption"]"
                  Value="@(Value?.StringSplitOption)"
                  ValueChanged="v => Update(o => o.StringSplitOption = string.IsNullOrWhiteSpace(v) ? null : v)"
                  Variant="Variant.Outlined" />

    <StringListEditor @bind-Items="_separators"
                      Label="@L["MetadataOpt_Separators"]"
                      Placeholder="e.g. ," />

    <StringListEditor @bind-Items="_trimChars"
                      Label="@L["MetadataOpt_TrimChars"]"
                      Placeholder="e.g. (space)" />

    <DictionaryEditor @bind-Items="_metadata"
                      Label="@L["MetadataOpt_Metadata"]"
                      KeyPlaceholder="key"
                      ValuePlaceholder="value" />
</MudStack>

@code {
    [Parameter] public MetadataOptions? Value { get; set; }
    [Parameter] public EventCallback<MetadataOptions?> ValueChanged { get; set; }

    private List<string>? _separators
    {
        get => Value?.Separators;
        set => Update(o => o.Separators = value);
    }

    private List<string>? _trimChars
    {
        get => Value?.TrimChars;
        set => Update(o => o.TrimChars = value);
    }

    private Dictionary<string, string>? _metadata
    {
        get => Value?.Metadata;
        set => Update(o => o.Metadata = value);
    }

    private void Update(Action<MetadataOptions> apply)
    {
        var v = Value ?? new MetadataOptions();
        apply(v);
        var result = IsEmpty(v) ? null : v;
        ValueChanged.InvokeAsync(result);
    }

    private static bool IsEmpty(MetadataOptions o) =>
        string.IsNullOrWhiteSpace(o.CurrentCulture) && string.IsNullOrWhiteSpace(o.NumberStyle)
        && (o.Separators is null || o.Separators.Count == 0)
        && string.IsNullOrWhiteSpace(o.StringSplitOption)
        && (o.TrimChars is null || o.TrimChars.Count == 0)
        && (o.Metadata is null || o.Metadata.Count == 0)
        && o.ExtensionData is null;
}
