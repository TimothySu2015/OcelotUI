@page "/routes"
@page "/"
@using MediatR
@using OcelotUI.Application.Routes.Queries.GetAllRoutes
@using OcelotUI.Application.Routes.Commands.DeleteRoute
@inject IMediator Mediator
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IStringLocalizer<SharedResource> L
@inject JsonPreviewState PreviewState

<div class="page-header page-header-routes">
    <MudText Typo="Typo.h5">@L["RouteList_Title"]</MudText>
</div>

<MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4" Spacing="2">
    <MudTextField T="string"
                  @bind-Value="_searchText"
                  Placeholder="@L["RouteList_Search"]"
                  Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Filled.Search"
                  Variant="Variant.Outlined"
                  Margin="Margin.Dense"
                  Immediate="true"
                  Class="flex-grow-1" />
    <MudButton Variant="Variant.Filled"
               Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.Add"
               OnClick="@(() => Navigation.NavigateTo("/routes/new"))">
        @L["RouteList_AddRoute"]
    </MudButton>
</MudStack>

@if (_loading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
}
else if (_routes is null)
{
    <MudAlert Severity="Severity.Error">@L["RouteList_LoadFailed"]</MudAlert>
}
else
{
    <MudDataGrid T="RouteListItemDto"
                 Items="FilteredRoutes"
                 Dense="true"
                 Hover="true"
                 Striped="true">
        <Columns>
            <PropertyColumn Property="x => x.Index" Title="#" />
            <TemplateColumn Title="@L["RouteList_Col_DisplayName"]">
                <CellTemplate>
                    @if (!string.IsNullOrWhiteSpace(context.Item.DisplayName))
                    {
                        <MudText Typo="Typo.body2">@context.Item.DisplayName</MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">â€”</MudText>
                    }
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="@L["RouteList_Col_Upstream"]">
                <CellTemplate>
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.body2">
                            <b>@string.Join(", ", context.Item.UpstreamHttpMethod)</b>
                            @context.Item.UpstreamPathTemplate
                        </MudText>
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="@L["RouteList_Col_Downstream"]">
                <CellTemplate>
                    <MudText Typo="Typo.body2">
                        @context.Item.DownstreamScheme://@context.Item.DownstreamHosts@context.Item.DownstreamPathTemplate
                    </MudText>
                </CellTemplate>
            </TemplateColumn>
            <PropertyColumn Property="x => x.Key" Title="@L["RouteList_Col_Key"]" />
            <TemplateColumn Title="@L["RouteList_Col_Actions"]" StickyRight="true">
                <CellTemplate>
                    <MudStack Row="true" Spacing="0">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                       Size="Size.Small"
                                       Color="Color.Primary"
                                       OnClick="@(() => Navigation.NavigateTo($"/routes/edit/{context.Item.Index}"))" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Size="Size.Small"
                                       Color="Color.Error"
                                       OnClick="@(() => ConfirmDelete(context.Item))" />
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>
}

@code {
    private List<RouteListItemDto>? _routes;
    private string _searchText = string.Empty;
    private bool _loading = true;

    private IEnumerable<RouteListItemDto> FilteredRoutes =>
        string.IsNullOrWhiteSpace(_searchText)
            ? _routes ?? []
            : (_routes ?? []).Where(r =>
                r.UpstreamPathTemplate.Contains(_searchText, StringComparison.OrdinalIgnoreCase)
                || (r.DisplayName is not null && r.DisplayName.Contains(_searchText, StringComparison.OrdinalIgnoreCase)));

    protected override async Task OnInitializedAsync()
    {
        await LoadRoutes();
    }

    private async Task LoadRoutes()
    {
        _loading = true;
        var result = await Mediator.Send(new GetAllRoutesQuery());
        _routes = result.IsSuccess ? result.Value : null;
        _loading = false;
    }

    private async Task ConfirmDelete(RouteListItemDto item)
    {
        var parameters = new DialogParameters<MudMessageBox>
        {
            { x => x.MarkupMessage,
              new MarkupString($"{L["RouteList_DeleteConfirm"]} <b>{item.UpstreamPathTemplate}</b>?") },
            { x => x.YesText, L["Btn_Delete"].Value },
            { x => x.NoText, L["Btn_Cancel"].Value }
        };

        var dialog = await DialogService.ShowAsync<MudMessageBox>(
            L["RouteList_ConfirmDeleteTitle"], parameters);
        var dialogResult = await dialog.Result;

        if (dialogResult?.Canceled != false)
            return;

        var result = await Mediator.Send(new DeleteRouteCommand(item.Index));

        if (result.IsSuccess)
        {
            Snackbar.Add(L["RouteList_DeleteSuccess"], Severity.Success);
            PreviewState.NotifyChanged();
            await LoadRoutes();
        }
        else
        {
            Snackbar.Add(string.Format(L["RouteEdit_Failed"], result.Error), Severity.Error);
        }
    }
}
