@page "/global-config"
@using MediatR
@using OcelotUI.Application.GlobalConfig.Queries.GetGlobalConfig
@using OcelotUI.Application.GlobalConfig.Commands.UpdateGlobalConfig
@using OcelotUI.Domain.Entities
@using OcelotUI.Web.Components.Shared
@inject IMediator Mediator
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IStringLocalizer<SharedResource> L
@inject IJSRuntime JS
@inject JsonPreviewState PreviewState
@implements IDisposable

<div class="page-header page-header-global">
    <MudText Typo="Typo.h5">@L["GlobalConfig_Title"]</MudText>
</div>

@if (_loading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
}
else
{
    <EditForm Model="_config" OnValidSubmit="Save">
        <MudStack Spacing="4">
            @* Toolbar *@
            <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2">
                <MudButton Variant="Variant.Outlined"
                           OnClick="Cancel">
                    @L["Btn_Cancel"]
                </MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           ButtonType="ButtonType.Submit"
                           Disabled="_saving">
                    @(_saving ? L["Saving"] : L["Btn_Save"])
                </MudButton>
            </MudStack>

            @* Basic Settings *@
            <MudPaper Class="pa-4" Elevation="1">
                <MudText Typo="Typo.h6" Class="mb-3">@L["GlobalConfig_Basic"]</MudText>
                <MudStack Spacing="3">
                    <MudTextField T="string"
                                  Label="@L["GlobalConfig_BaseUrl"]"
                                  @bind-Value="_config.BaseUrl"
                                  Variant="Variant.Outlined"
                                  Placeholder="https://my-gateway.com" />
                    <MudGrid>
                        <MudItem xs="3">
                            <MudSelect T="string"
                                       Label="@L["GlobalConfig_DownstreamScheme"]"
                                       Value="@(_config.DownstreamScheme ?? string.Empty)"
                                       ValueChanged="v => _config.DownstreamScheme = string.IsNullOrEmpty(v) ? null : v"
                                       Variant="Variant.Outlined">
                                <MudSelectItem T="string" Value="@string.Empty">—</MudSelectItem>
                                <MudSelectItem T="string" Value="@("https")">https</MudSelectItem>
                                <MudSelectItem T="string" Value="@("http")">http</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="3">
                            <MudTextField T="string"
                                          Label="@L["GlobalConfig_HttpVersion"]"
                                          @bind-Value="_config.DownstreamHttpVersion"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="3">
                            <DescriptiveSelect Label="@L["GlobalConfig_HttpVersionPolicy"]"
                                               Value="@(_config.DownstreamHttpVersionPolicy)"
                                               ValueChanged="v => _config.DownstreamHttpVersionPolicy = v"
                                               Options="_httpVersionPolicyOptions" />
                        </MudItem>
                        <MudItem xs="3">
                            <MudNumericField T="int?"
                                             Label="@L["GlobalConfig_Timeout"]"
                                             @bind-Value="_config.Timeout"
                                             Variant="Variant.Outlined" />
                        </MudItem>
                    </MudGrid>
                    <MudTextField T="string"
                                  Label="@L["GlobalConfig_RequestIdKey"]"
                                  @bind-Value="_config.RequestIdKey"
                                  Variant="Variant.Outlined" />
                </MudStack>
            </MudPaper>

            @* Sub-object Sections *@
            <MudExpansionPanels>
                <MudExpansionPanel>
                    <TitleContent>@PanelTitleWithGuide(L["GlobalConfig_ServiceDiscovery"], OcelotDocs + "servicediscovery.html", _config.ServiceDiscoveryProvider is not null, () => _config.ServiceDiscoveryProvider = null)</TitleContent>
                    <ChildContent><ServiceDiscoveryProviderEditor @bind-Value="_config.ServiceDiscoveryProvider" /></ChildContent>
                </MudExpansionPanel>

                <MudExpansionPanel>
                    <TitleContent>@PanelTitleWithGuide(L["RouteEdit_AuthenticationOptions"], OcelotDocs + "authentication.html", _config.AuthenticationOptions is not null, () => _config.AuthenticationOptions = null)</TitleContent>
                    <ChildContent><AuthenticationOptionsEditor @bind-Value="_config.AuthenticationOptions" ShowRouteKeys="true" /></ChildContent>
                </MudExpansionPanel>

                <MudExpansionPanel>
                    <TitleContent>@PanelTitleWithGuide(L["RouteEdit_RateLimitOptions"], OcelotDocs + "ratelimiting.html", _config.RateLimitOptions is not null, () => _config.RateLimitOptions = null)</TitleContent>
                    <ChildContent><RateLimitOptionsEditor @bind-Value="_config.RateLimitOptions" ShowRouteKeys="true" /></ChildContent>
                </MudExpansionPanel>

                <MudExpansionPanel>
                    <TitleContent>@PanelTitleWithGuide(L["RouteEdit_LoadBalancerOptions"], OcelotDocs + "loadbalancer.html", _config.LoadBalancerOptions is not null, () => _config.LoadBalancerOptions = null)</TitleContent>
                    <ChildContent><LoadBalancerOptionsEditor @bind-Value="_config.LoadBalancerOptions" ShowRouteKeys="true" /></ChildContent>
                </MudExpansionPanel>

                <MudExpansionPanel>
                    <TitleContent>@PanelTitleWithGuide(L["RouteEdit_QoSOptions"], OcelotDocs + "qualityofservice.html", _config.QoSOptions is not null, () => _config.QoSOptions = null)</TitleContent>
                    <ChildContent><QoSOptionsEditor @bind-Value="_config.QoSOptions" ShowRouteKeys="true" /></ChildContent>
                </MudExpansionPanel>

                <MudExpansionPanel>
                    <TitleContent>@PanelTitleWithGuide(L["RouteEdit_CacheOptions"], OcelotDocs + "caching.html", _config.CacheOptions is not null, () => _config.CacheOptions = null)</TitleContent>
                    <ChildContent><CacheOptionsEditor @bind-Value="_config.CacheOptions" ShowRouteKeys="true" /></ChildContent>
                </MudExpansionPanel>

                <MudExpansionPanel>
                    <TitleContent>@PanelTitleWithGuide(L["RouteEdit_HttpHandlerOptions"], OcelotDocs + "configuration.html", _config.HttpHandlerOptions is not null, () => _config.HttpHandlerOptions = null)</TitleContent>
                    <ChildContent><HttpHandlerOptionsEditor @bind-Value="_config.HttpHandlerOptions" ShowRouteKeys="true" /></ChildContent>
                </MudExpansionPanel>

                <MudExpansionPanel>
                    <TitleContent>@PanelTitleWithGuide(L["RouteEdit_SecurityOptions"], OcelotDocs + "routing.html", _config.SecurityOptions is not null, () => _config.SecurityOptions = null)</TitleContent>
                    <ChildContent><SecurityOptionsEditor @bind-Value="_config.SecurityOptions" /></ChildContent>
                </MudExpansionPanel>

                <MudExpansionPanel>
                    <TitleContent>@PanelTitleWithGuide(L["GlobalConfig_MetadataOptions"], OcelotDocs + "metadata.html", _config.MetadataOptions is not null, () => _config.MetadataOptions = null)</TitleContent>
                    <ChildContent><MetadataOptionsEditor @bind-Value="_config.MetadataOptions" /></ChildContent>
                </MudExpansionPanel>

                <MudExpansionPanel>
                    <TitleContent>@PanelTitleWithGuide(L["GlobalConfig_UpstreamHeaderTransform"], OcelotDocs + "headerstransformation.html", _config.UpstreamHeaderTransform is { Count: > 0 }, () => _config.UpstreamHeaderTransform = null)</TitleContent>
                    <ChildContent>
                        <DictionaryEditor @bind-Items="_config.UpstreamHeaderTransform"
                                          Label="@L["GlobalConfig_UpstreamHeaderTransform"]"
                                          KeyPlaceholder="Header"
                                          ValuePlaceholder="Transform" />
                    </ChildContent>
                </MudExpansionPanel>

                <MudExpansionPanel>
                    <TitleContent>@PanelTitleWithGuide(L["GlobalConfig_DownstreamHeaderTransform"], OcelotDocs + "headerstransformation.html", _config.DownstreamHeaderTransform is { Count: > 0 }, () => _config.DownstreamHeaderTransform = null)</TitleContent>
                    <ChildContent>
                        <DictionaryEditor @bind-Items="_config.DownstreamHeaderTransform"
                                          Label="@L["GlobalConfig_DownstreamHeaderTransform"]"
                                          KeyPlaceholder="Header"
                                          ValuePlaceholder="Transform" />
                    </ChildContent>
                </MudExpansionPanel>

                <MudExpansionPanel>
                    <TitleContent>@PanelTitleWithGuide(L["RouteEdit_Metadata"], OcelotDocs + "metadata.html", _config.Metadata is { Count: > 0 }, () => _config.Metadata = null)</TitleContent>
                    <ChildContent>
                        <DictionaryEditor @bind-Items="_config.Metadata"
                                          Label="@L["RouteEdit_Metadata"]"
                                          KeyPlaceholder="Key"
                                          ValuePlaceholder="Value" />
                    </ChildContent>
                </MudExpansionPanel>
            </MudExpansionPanels>
        </MudStack>
    </EditForm>
}

@code {
    private OcelotGlobalConfiguration _config = new();
    private bool _loading = true;
    private bool _saving;

    private IReadOnlyList<DescriptiveSelect.SelectOption> _httpVersionPolicyOptions =>
    [
        new("RequestVersionExact", L["HttpVersionPolicy_RequestVersionExact_Desc"]),
        new("RequestVersionOrLower", L["HttpVersionPolicy_RequestVersionOrLower_Desc"]),
        new("RequestVersionOrHigher", L["HttpVersionPolicy_RequestVersionOrHigher_Desc"]),
    ];

    protected override async Task OnInitializedAsync()
    {
        var result = await Mediator.Send(new GetGlobalConfigQuery());
        if (result.IsSuccess && result.Value is not null)
        {
            _config = result.Value.Config;
        }
        _loading = false;
        PreviewState.SetFocus(PreviewSection.GlobalConfiguration, null);
    }

    private async Task Save()
    {
        _saving = true;
        try
        {
            var result = await Mediator.Send(
                new UpdateGlobalConfigCommand(new GlobalConfigDto { Config = _config }));
            if (result.IsSuccess)
            {
                Snackbar.Add(L["GlobalConfig_SaveSuccess"], Severity.Success);
                PreviewState.NotifyChanged();
            }
            else
            {
                Snackbar.Add(string.Format(L["RouteEdit_Failed"], result.Error), Severity.Error);
            }
        }
        finally
        {
            _saving = false;
        }
    }

    private void Cancel() => Navigation.NavigateTo("/routes");

    public void Dispose() => PreviewState.ClearFocus();

    private const string OcelotDocs = "https://ocelot.readthedocs.io/en/latest/features/";

    private RenderFragment PanelTitleWithGuide(string label, string docUrl, bool configured = false, Action? onClear = null) => builder =>
    {
        builder.OpenComponent<MudStack>(0);
        builder.AddAttribute(1, "Row", true);
        builder.AddAttribute(2, "AlignItems", AlignItems.Center);
        builder.AddAttribute(3, "Spacing", 2);
        builder.AddAttribute(4, "ChildContent", (RenderFragment)(inner =>
        {
            inner.OpenComponent<MudText>(0);
            inner.AddAttribute(1, "ChildContent", (RenderFragment)(t => t.AddContent(0, label)));
            inner.CloseComponent();
            if (configured)
            {
                inner.OpenComponent<MudChip<string>>(2);
                inner.AddAttribute(3, "Size", Size.Small);
                inner.AddAttribute(4, "Color", Color.Info);
                inner.AddAttribute(5, "Variant", Variant.Filled);
                inner.AddAttribute(6, "ChildContent", (RenderFragment)(c => c.AddContent(0, "✔")));
                inner.CloseComponent();
            }
            inner.OpenComponent<MudTooltip>(10);
            inner.AddAttribute(11, "Text", L["Nav_Guide"].Value);
            inner.AddAttribute(12, "ChildContent", (RenderFragment)(tip =>
            {
                tip.OpenComponent<MudIconButton>(0);
                tip.AddAttribute(1, "Icon", Icons.Material.Outlined.HelpOutline);
                tip.AddAttribute(2, "Size", Size.Small);
                tip.AddAttribute(3, "Color", Color.Default);
                tip.AddAttribute(4, "OnClick", EventCallback.Factory.Create<MouseEventArgs>(this, () => JS.InvokeVoidAsync("open", docUrl, "_blank")));
                tip.CloseComponent();
            }));
            inner.CloseComponent();
            if (configured && onClear is not null)
            {
                var clearAction = onClear;
                inner.OpenElement(30, "div");
                inner.AddAttribute(31, "style", "display:inline-flex");
                inner.AddAttribute(32, "onclick", EventCallback.Factory.Create<MouseEventArgs>(this, () => { }));
                inner.AddEventStopPropagationAttribute(33, "onclick", true);
                inner.OpenComponent<MudTooltip>(34);
                inner.AddAttribute(35, "Text", L["Btn_ClearSection"].Value);
                inner.AddAttribute(36, "ChildContent", (RenderFragment)(tip =>
                {
                    tip.OpenComponent<MudIconButton>(0);
                    tip.AddAttribute(1, "Icon", Icons.Material.Outlined.ClearAll);
                    tip.AddAttribute(2, "Size", Size.Small);
                    tip.AddAttribute(3, "Color", Color.Warning);
                    tip.AddAttribute(4, "OnClick", EventCallback.Factory.Create<MouseEventArgs>(this, () =>
                    {
                        clearAction();
                        StateHasChanged();
                    }));
                    tip.CloseComponent();
                }));
                inner.CloseComponent();
                inner.CloseElement();
            }
        }));
        builder.CloseComponent();
    };
}
