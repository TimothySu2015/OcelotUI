@page "/dynamic-routes"
@using MediatR
@using OcelotUI.Application.DynamicRoutes.Queries.GetAllDynamicRoutes
@using OcelotUI.Application.DynamicRoutes.Commands.DeleteDynamicRoute
@inject IMediator Mediator
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IStringLocalizer<SharedResource> L
@inject JsonPreviewState PreviewState

<div class="page-header page-header-dynamic">
    <MudText Typo="Typo.h5">@L["DynamicRoute_Title"]</MudText>
</div>

<MudStack Row="true" Justify="Justify.FlexEnd" Class="mb-4">
    <MudButton Variant="Variant.Filled"
               Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.Add"
               OnClick="@(() => Navigation.NavigateTo("/dynamic-routes/new"))">
        @L["DynamicRoute_Add"]
    </MudButton>
</MudStack>

@if (_loading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
}
else if (_items is null)
{
    <MudAlert Severity="Severity.Error">@L["DynamicRoute_LoadFailed"]</MudAlert>
}
else
{
    <MudDataGrid T="DynamicRouteListItemDto"
                 Items="_items"
                 Dense="true"
                 Hover="true"
                 Striped="true">
        <Columns>
            <PropertyColumn Property="x => x.Index" Title="#" />
            <PropertyColumn Property="x => x.ServiceName" Title="@L["DynamicRoute_ServiceName"]" />
            <PropertyColumn Property="x => x.ServiceNamespace" Title="@L["DynamicRoute_ServiceNamespace"]" />
            <TemplateColumn Title="@L["RouteList_Col_Actions"]" StickyRight="true">
                <CellTemplate>
                    <MudStack Row="true" Spacing="0">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                       Size="Size.Small"
                                       Color="Color.Primary"
                                       OnClick="@(() => Navigation.NavigateTo($"/dynamic-routes/edit/{context.Item.Index}"))" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Size="Size.Small"
                                       Color="Color.Error"
                                       OnClick="@(() => ConfirmDelete(context.Item))" />
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>
}

@code {
    private List<DynamicRouteListItemDto>? _items;
    private bool _loading = true;

    protected override async Task OnInitializedAsync() => await Load();

    private async Task Load()
    {
        _loading = true;
        var result = await Mediator.Send(new GetAllDynamicRoutesQuery());
        _items = result.IsSuccess ? result.Value : null;
        _loading = false;
    }

    private async Task ConfirmDelete(DynamicRouteListItemDto item)
    {
        var parameters = new DialogParameters<MudMessageBox>
        {
            { x => x.MarkupMessage,
              new MarkupString($"{L["DynamicRoute_DeleteConfirm"]} <b>{item.ServiceName}</b>?") },
            { x => x.YesText, L["Btn_Delete"].Value },
            { x => x.NoText, L["Btn_Cancel"].Value }
        };

        var dialog = await DialogService.ShowAsync<MudMessageBox>(
            L["RouteList_ConfirmDeleteTitle"], parameters);
        var dialogResult = await dialog.Result;

        if (dialogResult?.Canceled != false) return;

        var result = await Mediator.Send(new DeleteDynamicRouteCommand(item.Index));
        if (result.IsSuccess)
        {
            Snackbar.Add(L["DynamicRoute_DeleteSuccess"], Severity.Success);
            PreviewState.NotifyChanged();
            await Load();
        }
        else
        {
            Snackbar.Add(string.Format(L["RouteEdit_Failed"], result.Error), Severity.Error);
        }
    }
}
