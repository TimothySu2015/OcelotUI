@using OcelotUI.Domain.Entities
@inject IStringLocalizer<SharedResource> L

<MudStack Spacing="3" Class="pa-2">
    <div class="d-flex align-start gap-1">
        <div style="flex:1">
            <DescriptiveSelect Label="@L["LoadBalancer_Type"]"
                               Value="@(Value?.Type)"
                               ValueChanged="v => Update(o => o.Type = v)"
                               Options="_lbOptions"
                               EmptyText="@($"({L["LoadBalancer_None"]})")" />
        </div>
        <HelpIcon Text="@L["LoadBalancer_Type_Desc"]" />
    </div>

    @if (Value?.Type == "CookieStickySessions")
    {
        <div class="d-flex align-start gap-1">
            <MudTextField T="string"
                          Label="@L["LoadBalancer_Key"]"
                          Value="@(Value?.Key)"
                          ValueChanged="v => Update(o => o.Key = string.IsNullOrWhiteSpace(v) ? null : v)"
                          Variant="Variant.Outlined"
                          HelperText="@L["LoadBalancer_Key_Helper"]"
                          Style="flex:1" />
            <HelpIcon Text="@L["LoadBalancer_Key_Desc"]" />
        </div>

        <div class="d-flex align-start gap-1">
            <MudNumericField T="int?"
                             Label="@L["LoadBalancer_Expiry"]"
                             Value="Value?.Expiry"
                             ValueChanged="v => Update(o => o.Expiry = v)"
                             Variant="Variant.Outlined"
                             HelperText="ms"
                             Style="flex:1" />
            <HelpIcon Text="@L["LoadBalancer_Expiry_Desc"]" />
        </div>
    }

    @if (ShowRouteKeys)
    {
        <StringListEditor @bind-Items="_routeKeys"
                          Label="@L["Global_RouteKeys"]"
                          Placeholder="e.g. route-key" />
    }
</MudStack>

@code {
    private IReadOnlyList<DescriptiveSelect.SelectOption> _lbOptions =>
    [
        new("RoundRobin", L["LB_RoundRobin_Desc"]),
        new("LeastConnection", L["LB_LeastConnection_Desc"]),
        new("CookieStickySessions", L["LB_CookieStickySessions_Desc"]),
        new("NoLoadBalancer", L["LB_NoLoadBalancer_Desc"]),
    ];

    [Parameter] public LoadBalancerOptions? Value { get; set; }
    [Parameter] public EventCallback<LoadBalancerOptions?> ValueChanged { get; set; }
    [Parameter] public bool ShowRouteKeys { get; set; }

    private List<string>? _routeKeys
    {
        get => Value?.RouteKeys;
        set => Update(o => o.RouteKeys = value);
    }

    private void Update(Action<LoadBalancerOptions> apply)
    {
        var v = Value ?? new LoadBalancerOptions();
        apply(v);
        var result = IsEmpty(v) ? null : v;
        ValueChanged.InvokeAsync(result);
    }

    private static bool IsEmpty(LoadBalancerOptions o) =>
        string.IsNullOrWhiteSpace(o.Type) && string.IsNullOrWhiteSpace(o.Key)
        && o.Expiry is null
        && (o.RouteKeys is null || o.RouteKeys.Count == 0)
        && o.ExtensionData is null;
}
