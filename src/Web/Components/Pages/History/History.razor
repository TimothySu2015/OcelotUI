@page "/history"
@using MediatR
@using OcelotUI.Application.Snapshots.Queries.GetAllSnapshots
@using OcelotUI.Application.Snapshots.Queries.GetSnapshotContent
@using OcelotUI.Application.Snapshots.Commands.RestoreSnapshot
@using OcelotUI.Application.Snapshots.Commands.DeleteSnapshot
@using OcelotUI.Application.Snapshots.Commands.ClearAllSnapshots
@using OcelotUI.Application.Snapshots.Commands.CreateSnapshot
@using OcelotUI.Domain.Entities
@inject IMediator Mediator
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@using OcelotUI.Application.Interfaces
@inject IStringLocalizer<SharedResource> L
@inject IOcelotConfigurationRepository ConfigRepository

<MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
    <MudText Typo="Typo.h4">@L["History_Title"]</MudText>
    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
        @if (_selected.Count == 2)
        {
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Compare"
                       OnClick="CompareSelected">
                @L["History_Compare"]
            </MudButton>
        }
        else if (_selected.Count >= 1)
        {
            <MudChip T="string" Color="Color.Default" Size="Size.Small">
                @string.Format(L["History_SelectCount"], _selected.Count)
            </MudChip>
        }
        <MudButton Variant="Variant.Filled"
                   Color="Color.Success"
                   StartIcon="@Icons.Material.Filled.AddCircle"
                   OnClick="CreateManualSnapshot">
            @L["History_ManualSave"]
        </MudButton>
        @if (_snapshots.Count > 0)
        {
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Error"
                       StartIcon="@Icons.Material.Filled.DeleteSweep"
                       OnClick="ClearAll">
                @L["History_ClearAll"]
            </MudButton>
        }
    </MudStack>
</MudStack>

@if (_loading)
{
    <MudProgressLinear Indeterminate="true" />
}
else if (_snapshots.Count == 0)
{
    <MudAlert Severity="Severity.Info">@L["History_Empty"]</MudAlert>
}
else
{
    <MudTable Items="_snapshots" Hover="true" Dense="true" Striped="true">
        <HeaderContent>
            <MudTh Style="width:48px"></MudTh>
            <MudTh>@L["History_Timestamp"]</MudTh>
            <MudTh>@L["History_Description"]</MudTh>
            <MudTh>@L["History_RouteCount"]</MudTh>
            <MudTh>@L["History_FileSize"]</MudTh>
            <MudTh Style="width:160px">@L["RouteList_Col_Actions"]</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>
                <MudCheckBox T="bool"
                             Value="_selected.Contains(context)"
                             ValueChanged="v => ToggleSelect(context, v)"
                             Disabled="@(!_selected.Contains(context) && _selected.Count >= 2)"
                             Size="Size.Small"
                             Color="Color.Primary" />
            </MudTd>
            <MudTd DataLabel="@L["History_Timestamp"]">@context.Timestamp.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</MudTd>
            <MudTd DataLabel="@L["History_Description"]">@context.Description</MudTd>
            <MudTd DataLabel="@L["History_RouteCount"]">@context.RouteCount</MudTd>
            <MudTd DataLabel="@L["History_FileSize"]">@FormatSize(context.FileSizeBytes)</MudTd>
            <MudTd>
                <MudTooltip Text="@L["History_Preview"]">
                    <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                   Size="Size.Small"
                                   Color="Color.Info"
                                   OnClick="() => Preview(context)" />
                </MudTooltip>
                <MudTooltip Text="@L["History_Restore"]">
                    <MudIconButton Icon="@Icons.Material.Filled.RestorePage"
                                   Size="Size.Small"
                                   Color="Color.Warning"
                                   OnClick="() => Restore(context)" />
                </MudTooltip>
                <MudTooltip Text="@L["History_Delete"]">
                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                   Size="Size.Small"
                                   Color="Color.Error"
                                   OnClick="() => Delete(context)" />
                </MudTooltip>
            </MudTd>
        </RowTemplate>
    </MudTable>
}

@code {
    private static readonly System.Text.Json.JsonSerializerOptions _jsonOptions = new()
    {
        WriteIndented = true,
        DefaultIgnoreCondition = System.Text.Json.Serialization.JsonIgnoreCondition.WhenWritingNull,
        Encoder = System.Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping
    };

    private List<ConfigSnapshot> _snapshots = [];
    private readonly HashSet<ConfigSnapshot> _selected = [];
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadSnapshots();
    }

    private async Task LoadSnapshots()
    {
        _loading = true;
        _selected.Clear();
        var result = await Mediator.Send(new GetAllSnapshotsQuery());
        if (result.IsSuccess && result.Value is not null)
        {
            _snapshots = result.Value.OrderByDescending(s => s.Timestamp).ToList();
        }
        _loading = false;
    }

    private async Task CreateManualSnapshot()
    {
        var parameters = new DialogParameters<ManualSnapshotDialog>
        {
            { x => x.DefaultDescription, "" }
        };

        var dialog = await DialogService.ShowAsync<ManualSnapshotDialog>(
            L["History_ManualSave"], parameters,
            new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });

        var dialogResult = await dialog.Result;
        if (dialogResult is null || dialogResult.Canceled)
            return;

        var desc = dialogResult.Data as string;
        if (string.IsNullOrWhiteSpace(desc))
            return;

        var result = await Mediator.Send(new CreateSnapshotCommand(desc));
        if (result.IsSuccess)
        {
            Snackbar.Add(L["History_ManualSaveSuccess"], Severity.Success);
            await LoadSnapshots();
        }
        else
        {
            Snackbar.Add(result.Error ?? "Failed.", Severity.Error);
        }
    }

    private void ToggleSelect(ConfigSnapshot snapshot, bool selected)
    {
        if (selected)
            _selected.Add(snapshot);
        else
            _selected.Remove(snapshot);
    }

    private async Task CompareSelected()
    {
        if (_selected.Count != 2) return;

        var pair = _selected.OrderBy(s => s.Timestamp).ToList();
        var older = pair[0];
        var newer = pair[1];

        var olderResult = await Mediator.Send(new GetSnapshotContentQuery(older.Id));
        var newerResult = await Mediator.Send(new GetSnapshotContentQuery(newer.Id));

        if (olderResult.IsFailure || olderResult.Value is null
            || newerResult.IsFailure || newerResult.Value is null)
        {
            Snackbar.Add("Failed to load snapshots for comparison.", Severity.Error);
            return;
        }

        var parameters = new DialogParameters<SnapshotDiffDialog>
        {
            { x => x.OriginalContent, olderResult.Value },
            { x => x.ModifiedContent, newerResult.Value },
            { x => x.OriginalLabel, $"{older.Timestamp.ToLocalTime():yyyy-MM-dd HH:mm:ss}" },
            { x => x.ModifiedLabel, $"{newer.Timestamp.ToLocalTime():yyyy-MM-dd HH:mm:ss}" }
        };

        await DialogService.ShowAsync<SnapshotDiffDialog>(
            L["History_Compare"], parameters,
            new DialogOptions { MaxWidth = MaxWidth.ExtraExtraLarge, FullWidth = true });
    }

    private async Task Preview(ConfigSnapshot snapshot)
    {
        var result = await Mediator.Send(new GetSnapshotContentQuery(snapshot.Id));
        if (result.IsFailure || result.Value is null)
        {
            Snackbar.Add(result.Error ?? "Failed to load snapshot.", Severity.Error);
            return;
        }

        var currentConfig = await ConfigRepository.LoadAsync();
        var currentJson = System.Text.Json.JsonSerializer.Serialize(currentConfig, _jsonOptions);

        var parameters = new DialogParameters<SnapshotDiffDialog>
        {
            { x => x.OriginalContent, result.Value },
            { x => x.ModifiedContent, currentJson },
            { x => x.OriginalLabel, $"{snapshot.Timestamp.ToLocalTime():yyyy-MM-dd HH:mm:ss} - {snapshot.Description}" },
            { x => x.ModifiedLabel, L["History_Current"] }
        };

        await DialogService.ShowAsync<SnapshotDiffDialog>(
            L["History_Preview"], parameters,
            new DialogOptions { MaxWidth = MaxWidth.ExtraExtraLarge, FullWidth = true });
    }

    private async Task Restore(ConfigSnapshot snapshot)
    {
        var message = string.Format(L["History_RestoreConfirmDetail"],
            snapshot.Timestamp.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss"),
            snapshot.RouteCount);

        var confirmed = await DialogService.ShowMessageBox(
            L["History_Restore"],
            message,
            yesText: L["Confirm"],
            cancelText: L["Btn_Cancel"]);

        if (confirmed != true) return;

        var result = await Mediator.Send(new RestoreSnapshotCommand(snapshot.Id));
        if (result.IsSuccess)
        {
            Snackbar.Add(L["History_RestoreSuccess"], Severity.Success);
            await LoadSnapshots();
        }
        else
        {
            Snackbar.Add(result.Error ?? "Restore failed.", Severity.Error);
        }
    }

    private async Task Delete(ConfigSnapshot snapshot)
    {
        var confirmed = await DialogService.ShowMessageBox(
            L["History_Delete"],
            L["History_DeleteConfirm"],
            yesText: L["Confirm"],
            cancelText: L["Btn_Cancel"]);

        if (confirmed != true) return;

        var result = await Mediator.Send(new DeleteSnapshotCommand(snapshot.Id));
        if (result.IsSuccess)
        {
            _selected.Remove(snapshot);
            _snapshots.Remove(snapshot);
        }
        else
        {
            Snackbar.Add(result.Error ?? "Delete failed.", Severity.Error);
        }
    }

    private async Task ClearAll()
    {
        var confirmed = await DialogService.ShowMessageBox(
            L["History_ClearAll"],
            L["History_ClearAllConfirm"],
            yesText: L["Confirm"],
            cancelText: L["Btn_Cancel"]);

        if (confirmed != true) return;

        var result = await Mediator.Send(new ClearAllSnapshotsCommand());
        if (result.IsSuccess)
        {
            _snapshots.Clear();
            _selected.Clear();
            Snackbar.Add(L["History_ClearAllSuccess"], Severity.Success);
        }
        else
        {
            Snackbar.Add(result.Error ?? "Clear failed.", Severity.Error);
        }
    }

    private static string FormatSize(long bytes)
    {
        if (bytes is >= 0 and <= 1023)
            return $"{bytes} B";
        if (bytes is >= 1024 and <= 1048575)
            return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }
}
