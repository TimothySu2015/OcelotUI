@page "/dynamic-routes/new"
@page "/dynamic-routes/edit/{Index:int}"
@using MediatR
@using OcelotUI.Application.DynamicRoutes.Queries.GetDynamicRouteByIndex
@using OcelotUI.Application.DynamicRoutes.Commands.AddDynamicRoute
@using OcelotUI.Application.DynamicRoutes.Commands.UpdateDynamicRoute
@using OcelotUI.Domain.Entities
@using OcelotUI.Web.Components.Shared
@inject IMediator Mediator
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IStringLocalizer<SharedResource> L
@inject IJSRuntime JS

<MudText Typo="Typo.h5" Class="mb-4">
    @(IsNew ? L["DynamicRoute_NewTitle"] : string.Format(L["DynamicRoute_EditTitle"], Index))
</MudText>

@if (_loading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
}
else
{
    <EditForm Model="_dynamicRoute" OnValidSubmit="Save">
        <MudStack Spacing="4">
            <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2">
                <MudButton Variant="Variant.Outlined" OnClick="Cancel">@L["Btn_Cancel"]</MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           ButtonType="ButtonType.Submit"
                           Disabled="_saving">
                    @(_saving ? L["Saving"] : L["Btn_Save"])
                </MudButton>
            </MudStack>

            <MudPaper Class="pa-4" Elevation="1">
                <MudStack Spacing="3">
                    <MudGrid>
                        <MudItem xs="6">
                            <MudTextField T="string"
                                          Label="@L["DynamicRoute_ServiceName"]"
                                          @bind-Value="_dynamicRoute.ServiceName"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudTextField T="string"
                                          Label="@L["DynamicRoute_ServiceNamespace"]"
                                          @bind-Value="_dynamicRoute.ServiceNamespace"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                    </MudGrid>
                    <MudGrid>
                        <MudItem xs="4">
                            <MudTextField T="string"
                                          Label="@L["GlobalConfig_HttpVersion"]"
                                          @bind-Value="_dynamicRoute.DownstreamHttpVersion"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="4">
                            <MudTextField T="string"
                                          Label="@L["GlobalConfig_HttpVersionPolicy"]"
                                          @bind-Value="_dynamicRoute.DownstreamHttpVersionPolicy"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="4">
                            <MudNumericField T="int?"
                                             Label="@L["RouteEdit_Timeout"]"
                                             @bind-Value="_dynamicRoute.Timeout"
                                             Variant="Variant.Outlined" />
                        </MudItem>
                    </MudGrid>
                </MudStack>
            </MudPaper>

            <MudExpansionPanels>
                <MudExpansionPanel>
                    <TitleContent>@PanelTitleWithGuide(L["RouteEdit_AuthenticationOptions"], OcelotDocs + "servicediscovery.html")</TitleContent>
                    <ChildContent><AuthenticationOptionsEditor @bind-Value="_dynamicRoute.AuthenticationOptions" /></ChildContent>
                </MudExpansionPanel>

                <MudExpansionPanel>
                    <TitleContent>@PanelTitleWithGuide(L["RouteEdit_RateLimitOptions"], OcelotDocs + "servicediscovery.html")</TitleContent>
                    <ChildContent><RateLimitOptionsEditor @bind-Value="_dynamicRoute.RateLimitOptions" /></ChildContent>
                </MudExpansionPanel>

                <MudExpansionPanel>
                    <TitleContent>@PanelTitleWithGuide(L["RouteEdit_LoadBalancerOptions"], OcelotDocs + "servicediscovery.html")</TitleContent>
                    <ChildContent><LoadBalancerOptionsEditor @bind-Value="_dynamicRoute.LoadBalancerOptions" /></ChildContent>
                </MudExpansionPanel>

                <MudExpansionPanel>
                    <TitleContent>@PanelTitleWithGuide(L["RouteEdit_QoSOptions"], OcelotDocs + "servicediscovery.html")</TitleContent>
                    <ChildContent><QoSOptionsEditor @bind-Value="_dynamicRoute.QoSOptions" /></ChildContent>
                </MudExpansionPanel>

                <MudExpansionPanel>
                    <TitleContent>@PanelTitleWithGuide(L["RouteEdit_CacheOptions"], OcelotDocs + "servicediscovery.html")</TitleContent>
                    <ChildContent><CacheOptionsEditor @bind-Value="_dynamicRoute.CacheOptions" /></ChildContent>
                </MudExpansionPanel>

                <MudExpansionPanel>
                    <TitleContent>@PanelTitleWithGuide(L["RouteEdit_HttpHandlerOptions"], OcelotDocs + "servicediscovery.html")</TitleContent>
                    <ChildContent><HttpHandlerOptionsEditor @bind-Value="_dynamicRoute.HttpHandlerOptions" /></ChildContent>
                </MudExpansionPanel>

                <MudExpansionPanel>
                    <TitleContent>@PanelTitleWithGuide(L["RouteEdit_Metadata"], OcelotDocs + "servicediscovery.html")</TitleContent>
                    <ChildContent>
                        <DictionaryEditor @bind-Items="_dynamicRoute.Metadata"
                                          Label="@L["RouteEdit_Metadata"]"
                                          KeyPlaceholder="Key"
                                          ValuePlaceholder="Value" />
                    </ChildContent>
                </MudExpansionPanel>
            </MudExpansionPanels>
        </MudStack>
    </EditForm>
}

@code {
    [Parameter] public int? Index { get; set; }

    private bool IsNew => Index is null;
    private OcelotDynamicRoute _dynamicRoute = new();
    private bool _loading = true;
    private bool _saving;

    protected override async Task OnInitializedAsync()
    {
        if (!IsNew)
        {
            var result = await Mediator.Send(new GetDynamicRouteByIndexQuery(Index!.Value));
            if (result.IsSuccess && result.Value is not null)
            {
                _dynamicRoute = result.Value.DynamicRoute;
            }
            else
            {
                Snackbar.Add(L["DynamicRoute_NotFound"], Severity.Error);
                Navigation.NavigateTo("/dynamic-routes");
                return;
            }
        }
        _loading = false;
    }

    private async Task Save()
    {
        _saving = true;
        try
        {
            var dto = new DynamicRouteDetailDto { Index = Index, DynamicRoute = _dynamicRoute };

            if (IsNew)
            {
                var result = await Mediator.Send(new AddDynamicRouteCommand(dto));
                if (result.IsSuccess)
                {
                    Snackbar.Add(L["DynamicRoute_SaveSuccess"], Severity.Success);
                    Navigation.NavigateTo("/dynamic-routes");
                }
                else
                {
                    Snackbar.Add(string.Format(L["RouteEdit_Failed"], result.Error), Severity.Error);
                }
            }
            else
            {
                var result = await Mediator.Send(new UpdateDynamicRouteCommand(Index!.Value, dto));
                if (result.IsSuccess)
                {
                    Snackbar.Add(L["DynamicRoute_SaveSuccess"], Severity.Success);
                    Navigation.NavigateTo("/dynamic-routes");
                }
                else
                {
                    Snackbar.Add(string.Format(L["RouteEdit_Failed"], result.Error), Severity.Error);
                }
            }
        }
        finally { _saving = false; }
    }

    private void Cancel() => Navigation.NavigateTo("/dynamic-routes");

    private const string OcelotDocs = "https://ocelot.readthedocs.io/en/latest/features/";

    private RenderFragment PanelTitleWithGuide(string label, string docUrl) => builder =>
    {
        builder.OpenComponent<MudStack>(0);
        builder.AddAttribute(1, "Row", true);
        builder.AddAttribute(2, "AlignItems", AlignItems.Center);
        builder.AddAttribute(3, "Spacing", 2);
        builder.AddAttribute(4, "ChildContent", (RenderFragment)(inner =>
        {
            inner.OpenComponent<MudText>(0);
            inner.AddAttribute(1, "ChildContent", (RenderFragment)(t => t.AddContent(0, label)));
            inner.CloseComponent();
            inner.OpenComponent<MudTooltip>(10);
            inner.AddAttribute(11, "Text", L["Nav_Guide"].Value);
            inner.AddAttribute(12, "ChildContent", (RenderFragment)(tip =>
            {
                tip.OpenComponent<MudIconButton>(0);
                tip.AddAttribute(1, "Icon", Icons.Material.Outlined.HelpOutline);
                tip.AddAttribute(2, "Size", Size.Small);
                tip.AddAttribute(3, "Color", Color.Default);
                tip.AddAttribute(4, "OnClick", EventCallback.Factory.Create<MouseEventArgs>(this, () => JS.InvokeVoidAsync("open", docUrl, "_blank")));
                tip.CloseComponent();
            }));
            inner.CloseComponent();
        }));
        builder.CloseComponent();
    };
}
